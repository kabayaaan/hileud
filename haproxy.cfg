global
    log stdout format raw daemon
    maxconn 2048
    tune.ssl.default-dh-param 2048

defaults
    log global
    timeout connect 5s
    timeout client 60s
    timeout server 60s

# HTTP (80 & 8080) - WS only
frontend xray_http
    bind *:80
    bind *:8080
    mode http

    acl is_trojan path_beg /trojanws
    acl is_vless path_beg /vless
    acl is_vmess path_beg /vmess

    use_backend trojan_backend if is_trojan
    use_backend vless_backend if is_vless
    use_backend vmess_backend if is_vmess

# TLS Multiplexing (443) - WS only
frontend xray_tls
    bind *:443 ssl crt /etc/ssl/xray.pem alpn http/1.1
    mode tcp
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }

    default_backend tls_ws_backend

# TCP passthrough to internal decrypted WS handler
backend tls_ws_backend
    mode tcp
    server local_ws 127.0.0.1:8443

# Internal frontend (decrypted TLS â†’ HTTP WS)
frontend ws_over_tls
    bind 127.0.0.1:8443
    mode http

    acl is_trojan path_beg /trojanws
    acl is_vless path_beg /vless
    acl is_vmess path_beg /vmess

    use_backend trojan_backend if is_trojan
    use_backend vless_backend if is_vless
    use_backend vmess_backend if is_vmess

# WebSocket backends
backend trojan_backend
    mode http
    server trojan_ws 127.0.0.1:10001

backend vless_backend
    mode http
    server vless_ws 127.0.0.1:10002

backend vmess_backend
    mode http
    server vmess_ws 127.0.0.1:10003
